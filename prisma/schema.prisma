generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "linux-arm64-openssl-3.0.x", "linux-musl-arm64-openssl-3.0.x"]
}

// generator zod {
//   provider = "zod-prisma-types"
// }

datasource db {
  provider = "postgres"
  url      = env("DATABASE_URL")
}

model accounts {
  id            Int             @id @default(autoincrement())
  name          String          @default("") @db.VarChar
  nickname      String          @default("") @db.VarChar
  password      String          @default("") @db.VarChar
  image         String          @default("") @db.VarChar
  apiToken      String          @default("") @db.VarChar
  description   String          @default("") @db.Text
  note          Int             @default(0)
  role          String          @default("") @db.VarChar
  loginType     String          @default("") @db.VarChar
  linkAccountId Int?
  createdAt     DateTime        @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime        @updatedAt @db.Timestamptz(6)
  notes         notes[]
  configs       config[]
  tags          tag[]
  comments      comments[]
  attachments   attachments[]
  follows       follows[]
  notifications notifications[]
  conversations conversation[]
  sharedNotes   noteInternalShare[]
  todoGroups    todoGroup[]
  docs          docs[]
  okrObjectives okrObjectives[]
  okrTasks      okrTasks[]
}

model attachments {
  id            Int      @id @default(autoincrement())
  isShare       Boolean  @default(false)
  sharePassword String   @default("") @db.VarChar
  name          String   @default("") @db.VarChar
  path          String   @default("") @db.VarChar
  size          Decimal  @default(0) @db.Decimal
  type          String   @default("") @db.VarChar
  noteId        Int?
  docId         Int?
  accountId     Int?
  sortOrder     Int      @default(0)
  createdAt     DateTime @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @db.Timestamptz(6)
  perfixPath    String?  @default("") @db.VarChar // folder1,folder2,folder3
  depth         Int?
  metadata      Json?           @db.Json

  note    notes?    @relation(fields: [noteId], references: [id])
  doc     docs?     @relation(fields: [docId], references: [id])
  account accounts? @relation(fields: [accountId], references: [id])
}

model config {
  id     Int       @id @default(autoincrement())
  key    String    @default("") @db.VarChar
  config Json?     @db.Json
  userId Int?
  user   accounts? @relation(fields: [userId], references: [id])
}

model notes {
  id                Int             @id @default(autoincrement())
  type              Int             @default(0)
  content           String          @default("") @db.VarChar
  isArchived        Boolean         @default(false)
  isRecycle         Boolean         @default(false)
  isShare           Boolean         @default(false)
  isTop             Boolean         @default(false)
  isReviewed        Boolean         @default(false)
  sharePassword     String          @default("") @db.VarChar
  shareEncryptedUrl String?         @db.VarChar
  shareExpiryDate   DateTime?       @db.Timestamptz(6)
  shareMaxView      Int?            @default(0)
  shareViewCount    Int?            @default(0)
  metadata          Json?           @db.Json
  accountId         Int?
  sortOrder         Int             @default(0)
  createdAt         DateTime        @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime        @updatedAt @db.Timestamptz(6)

  // 层级关系（子任务支持）
  parentId         Int?
  depth            Int              @default(0)
  path             String?          @default("")

  // 来源追踪（卡片整合）
  sourceCardIds    Int[]            @default([])

  // Wiki-Link 支持
  wikiLinks        Json?

  // 关系
  parent           notes?           @relation("NoteHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children         notes[]          @relation("NoteHierarchy")
  groupId          Int?
  group            todoGroup?       @relation(fields: [groupId], references: [id])

  attachments       attachments[]
  tags              tagsToNote[]
  account           accounts?       @relation(fields: [accountId], references: [id])
  referencedBy      noteReference[] @relation("ReferencedNote")
  references        noteReference[] @relation("ReferencingNote")
  comments          comments[]      @relation("NoteComments")
  histories         noteHistory[]
  recurrences       todoRecurrence?
  internalShares    noteInternalShare[]
  okrNoteRelations  okrNoteRelations[]

  @@index([accountId])
  @@index([parentId])
  @@index([sourceCardIds])
  @@index([groupId])
}

model comments {
  id        Int      @id @default(autoincrement())
  content   String   @db.Text
  accountId Int?
  guestName String?  @db.VarChar
  guestIP   String?  @db.VarChar
  guestUA   String?  @db.VarChar
  noteId    Int
  parentId  Int?
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  note    notes      @relation("NoteComments", fields: [noteId], references: [id])
  account accounts?  @relation(fields: [accountId], references: [id])
  parent  comments?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies comments[] @relation("CommentReplies")
}

model tag {
  id         Int          @id @default(autoincrement())
  name       String       @default("") @db.VarChar
  icon       String       @default("") @db.VarChar
  parent     Int          @default(0)
  accountId  Int?
  createdAt  DateTime     @default(now()) @db.Timestamptz(6)
  updatedAt  DateTime     @updatedAt @db.Timestamptz(6)
  tagsToNote tagsToNote[]
  tagsToDoc  tagsToDoc[]
  sortOrder  Int          @default(0)
  account    accounts?    @relation(fields: [accountId], references: [id])
}

model tagsToNote {
  id     Int @default(autoincrement())
  noteId Int @default(0)
  tagId  Int @default(0)

  note notes @relation(fields: [noteId], references: [id])
  tag  tag   @relation(fields: [tagId], references: [id])

  @@id([noteId, tagId])
}

model scheduledTask {
  name      String   @id
  schedule  String
  lastRun   DateTime @default(now())
  isSuccess Boolean  @default(true)
  isRunning Boolean  @default(false)
  output    Json?    @db.Json
}

model noteReference {
  id             Int      @id @default(autoincrement())
  fromNoteId     Int
  toNoteId       Int
  referenceType  String   @default("manual") @db.VarChar // manual | wiki_link | integration | todo_parent
  createdAt      DateTime @default(now()) @db.Timestamptz(6)

  fromNote notes @relation("ReferencingNote", fields: [fromNoteId], references: [id])
  toNote   notes @relation("ReferencedNote", fields: [toNoteId], references: [id])

  @@unique([fromNoteId, toNoteId])
  @@index([referenceType])
}

model follows {
  id          Int     @id @default(autoincrement())
  siteName    String? @db.VarChar
  siteUrl     String  @db.VarChar
  siteAvatar  String? @db.VarChar
  description String? @db.Text

  createdAt  DateTime @default(now()) @db.Timestamptz(6)
  updatedAt  DateTime @updatedAt @db.Timestamptz(6)
  followType String   @default("following") @db.VarChar //  "following" or "follower"

  accountId Int
  account   accounts @relation(fields: [accountId], references: [id])
}

model notifications {
  id        Int      @id @default(autoincrement())
  type      String   @db.VarChar // follow, comment, mention 等
  title     String   @db.VarChar
  content   String   @db.Text
  metadata  Json?    @db.Json
  isRead    Boolean  @default(false)
  accountId Int
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  account accounts @relation(fields: [accountId], references: [id])
}

model cache {
  id        Int      @id @default(autoincrement())
  key       String   @unique @db.VarChar
  value     Json     @db.Json
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)
}

model plugin {
  id        Int      @id @default(autoincrement())
  metadata  Json     @db.Json
  path      String   @db.VarChar
  isUse     Boolean  @default(true)
  isDev     Boolean  @default(false)
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)
}

model conversation {
  id        Int       @id @default(autoincrement())
  title     String    @default("") @db.VarChar(255)
  isShare   Boolean   @default(false)
  accountId Int
  createdAt DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @db.Timestamptz(6)
  messages  message[]

  account accounts @relation(fields: [accountId], references: [id])

  @@index([accountId])
}

model message {
  id             Int      @id @default(autoincrement())
  content        String   @db.Text
  role           String   @db.VarChar(50) // user or assistant
  conversationId Int
  createdAt      DateTime @default(now()) @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @db.Timestamptz(6)
  metadata       Json?    @db.Json

  conversation conversation @relation(fields: [conversationId], references: [id])

  @@index([conversationId])
}

model noteHistory {
  id        Int      @id @default(autoincrement())
  noteId    Int
  content   String   @db.Text
  metadata  Json?    @db.Json
  version   Int
  accountId Int?
  createdAt DateTime @default(now()) @db.Timestamptz(6)

  note notes @relation(fields: [noteId], references: [id], onDelete: Cascade)

  @@index([noteId])
  @@index([accountId])
}

model noteInternalShare {
  id        Int      @id @default(autoincrement())
  noteId    Int
  accountId Int
  canEdit   Boolean  @default(true)
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  note    notes    @relation(fields: [noteId], references: [id], onDelete: Cascade)
  account accounts @relation(fields: [accountId], references: [id])

  @@unique([noteId, accountId])
  @@index([noteId])
  @@index([accountId])
}

model session {
  id        String   @id
  sid       String   @unique
  data      String   @db.Text
  expiresAt DateTime
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  @@index([expiresAt])
}

model aiProviders {
  id        Int      @id @default(autoincrement())
  title     String   @db.VarChar(255)
  provider  String   @db.VarChar(50)
  baseURL   String?  @db.VarChar(500)
  apiKey    String?  @db.VarChar(500)
  config    Json?    @db.Json
  sortOrder Int      @default(0)
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  models    aiModels[]
}

model aiModels {
  id            Int      @id @default(autoincrement())
  providerId    Int
  title         String   @db.VarChar(255)
  modelKey      String   @db.VarChar(255)
  capabilities  Json     @db.Json
  config        Json?    @db.Json
  sortOrder     Int      @default(0)
  createdAt     DateTime @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @db.Timestamptz(6)

  provider      aiProviders @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@index([providerId])
}

// 任务循环规则表
model todoRecurrence {
  id              Int       @id @default(autoincrement())
  noteId          Int       @unique
  rrule           String    @db.VarChar(500) // RRULE 格式的循环规则
  nextDueDate     DateTime? @db.Timestamptz(6)
  endDate         DateTime? @db.Timestamptz(6)
  maxOccurrences  Int?
  createdAt       DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @db.Timestamptz(6)

  note            notes     @relation(fields: [noteId], references: [id], onDelete: Cascade)

  @@index([nextDueDate])
}

// 任务分组表
model todoGroup {
  id        Int      @id @default(autoincrement())
  name      String   @db.VarChar(100)
  color     String   @default("#3b82f6") @db.VarChar(20)
  icon      String   @default("solar:folder-bold") @db.VarChar(50)
  sortOrder Int      @default(0)
  accountId Int
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  notes     notes[]
  account   accounts @relation(fields: [accountId], references: [id])

  @@index([accountId])
}

// 长笔记/文档表
model docs {
  id            Int        @id @default(autoincrement())
  title         String     @default("") @db.VarChar(255)
  content       String     @default("") @db.Text
  icon          String?    @db.VarChar(50)

  // 层级结构
  parentId      Int?
  depth         Int        @default(0)
  path          String?    @default("") @db.VarChar(1000)
  sortOrder     Int        @default(0)

  // 状态
  isPinned      Boolean    @default(false)
  isLocked      Boolean    @default(false)

  // 闪念合并追踪
  sourceCardIds Int[]      @default([])

  metadata      Json?      @db.Json
  accountId     Int
  createdAt     DateTime   @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime   @updatedAt @db.Timestamptz(6)

  parent        docs?      @relation("DocHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children      docs[]     @relation("DocHierarchy")
  account       accounts   @relation(fields: [accountId], references: [id])
  attachments   attachments[]
  tags          tagsToDoc[]
  histories     docHistory[]

  @@index([accountId])
  @@index([parentId])
  @@index([sourceCardIds])
}

// 文档历史记录表
model docHistory {
  id        Int      @id @default(autoincrement())
  docId     Int
  content   String   @db.Text
  title     String   @db.VarChar(255)
  metadata  Json?    @db.Json
  version   Int
  accountId Int?
  createdAt DateTime @default(now()) @db.Timestamptz(6)

  doc       docs     @relation(fields: [docId], references: [id], onDelete: Cascade)

  @@index([docId])
  @@index([accountId])
}

// 文档-标签关联表
model tagsToDoc {
  id    Int @default(autoincrement())
  docId Int @default(0)
  tagId Int @default(0)

  doc   docs @relation(fields: [docId], references: [id])
  tag   tag  @relation(fields: [tagId], references: [id])

  @@id([docId, tagId])
}

// OKR 目标表
model okrObjectives {
  id            Int        @id @default(autoincrement())
  title         String     @db.VarChar(255)
  description   String?    @db.Text
  status        String     @default("PENDING") @db.VarChar(20) // PENDING, ACHIEVED, FAILED, ARCHIVED
  period        String     @default("MONTHLY") @db.VarChar(20) // WEEKLY, MONTHLY, QUARTERLY, YEARLY, CUSTOM
  startDate     DateTime   @db.Timestamptz(6)
  endDate       DateTime?  @db.Timestamptz(6)
  progress      Decimal    @default(0) @db.Decimal
  sortOrder     Int        @default(0)
  accountId     Int
  createdAt     DateTime   @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime   @updatedAt @db.Timestamptz(6)

  account       accounts       @relation(fields: [accountId], references: [id])
  keyResults    okrKeyResults[]
  tasks         okrTasks[]
  noteRelations okrNoteRelations[]

  @@index([accountId])
  @@index([status])
  @@index([startDate])
}

// OKR 关键结果表
model okrKeyResults {
  id            Int        @id @default(autoincrement())
  objectiveId   Int
  title         String     @db.VarChar(255)
  description   String?    @db.Text
  status        String     @default("PENDING") @db.VarChar(20) // PENDING, IN_PROGRESS, ACHIEVED, FAILED
  targetValue   Decimal?   @db.Decimal
  currentValue  Decimal    @default(0) @db.Decimal
  unit          String?    @db.VarChar(50)
  sortOrder     Int        @default(0)
  createdAt     DateTime   @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime   @updatedAt @db.Timestamptz(6)

  objective     okrObjectives @relation(fields: [objectiveId], references: [id], onDelete: Cascade)
  tasks         okrTasks[]

  @@index([objectiveId])
  @@index([status])
}

// OKR 任务表
model okrTasks {
  id              Int        @id @default(autoincrement())
  title           String     @db.VarChar(255)
  description     String?    @db.Text
  status          String     @default("PENDING") @db.VarChar(20) // PENDING, IN_PROGRESS, COMPLETED, CANCELLED, BLOCKED
  taskType        String     @default("DAILY") @db.VarChar(20) // DAILY, CREATIVE, SUBTASK, FLASH
  priority        String     @default("MEDIUM") @db.VarChar(20) // LOW, MEDIUM, HIGH, URGENT
  objectiveId     Int?
  keyResultId     Int?
  dueDate         DateTime?  @db.Timestamptz(6)
  completedAt     DateTime?  @db.Timestamptz(6)
  estimatedHours  Decimal?   @db.Decimal
  actualHours     Decimal    @default(0) @db.Decimal
  sortOrder       Int        @default(0)
  accountId       Int
  createdAt       DateTime   @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime   @updatedAt @db.Timestamptz(6)

  account         accounts        @relation(fields: [accountId], references: [id])
  objective       okrObjectives?  @relation(fields: [objectiveId], references: [id], onDelete: SetNull)
  keyResult       okrKeyResults?  @relation(fields: [keyResultId], references: [id], onDelete: SetNull)
  timeEntries     okrTimeEntries[]
  noteRelations   okrNoteRelations[]

  @@index([accountId])
  @@index([objectiveId])
  @@index([keyResultId])
  @@index([status])
  @@index([dueDate])
}

// OKR 时间记录表
model okrTimeEntries {
  id            Int        @id @default(autoincrement())
  taskId        Int
  hours         Decimal    @db.Decimal
  description   String?    @db.Text
  date          DateTime   @db.Timestamptz(6)
  createdAt     DateTime   @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime   @updatedAt @db.Timestamptz(6)

  task          okrTasks   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([date])
}

// OKR 笔记关联表
model okrNoteRelations {
  id            Int        @id @default(autoincrement())
  noteId        Int
  objectiveId   Int?
  keyResultId   Int?
  taskId        Int?
  relationType  String     @default("TASK_NOTE") @db.VarChar(30) // OBJECTIVE_NOTE, KR_NOTE, TASK_NOTE, FLASH_NOTE
  createdAt     DateTime   @default(now()) @db.Timestamptz(6)

  note          notes          @relation(fields: [noteId], references: [id], onDelete: Cascade)
  objective     okrObjectives? @relation(fields: [objectiveId], references: [id], onDelete: Cascade)
  task          okrTasks?      @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([noteId])
  @@index([objectiveId])
  @@index([taskId])
}

